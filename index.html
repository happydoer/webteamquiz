<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tree Testing Landing Page</title>
  <style>
    .hidden { display: none; }
    .question-box, .menu-box, .submenu-box, .navigation, .selected-info, .login-box, .summary-box { margin: 20px 0; }
    button { margin: 5px; }
    body {
    font-family: 'Segoe UI', Tahoma, 'Geneva', Verdana, sans-serif;
    background-color: #f0f4f8;
    margin: 0;
    padding: 20px;
    color: #1a1a1a;
    }
    h1, h2 {
      text-align: center;
      color: #0a1f44; /* Navy */
    }
    .question-box, .menu-box, .submenu-box, .navigation, .selected-info, .login-box, .summary-box {
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      padding: 20px;
      margin: 20px auto;
      max-width: 650px;
      border-left: 6px solid #0a1f44;
    }
    input[type="text"] {
    padding: 10px;
    width: calc(100% - 22px);
    margin-top: 5px;
    margin-bottom: 10px;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-size: 16px;
    }
    button {
    background-color: #0a1f44; /* Navy */
    color: white;
    border: none;
    padding: 10px 20px;
    margin: 5px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: background-color 0.3s;
    }
    button:hover {
        background-color: #e53935; /* Red */
    }
    #selectedText, #summaryUser, .summary-box ul, .summary-box p {
    font-size: 16px;
    margin-top: 10px;
    }
    #summaryList li {
        padding: 6px 0;
        border-bottom: 1px solid #eee;
    }
    canvas#summaryChart {
    display: block;
    margin: 20px auto;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<body>
      <script>
    window.onload = loadSession;
  </script>
  <h1>Tree Testing Landing Page</h1>

  <div class="login-box" id="loginBox">
    <label for="userId">Enter User ID:</label>
    <input type="text" id="userId" />
    <button id="startBtn" onclick="validateUserId()">Start</button>
    <button id="resumeBtn" class="hidden" onclick="resumeSession()">Continue with previous session</button>
    <button id="newUserBtn" class="hidden" onclick="startNewSession()">Start with new User</button>
    <p id="loginMessage" style="color: red;"></p>
  </div>

  <div class="question-box hidden">
    <p id="question"></p>
  </div>

  <div class="menu-box hidden">
    <p>Select category:</p>
    <div id="topMenus"></div>
  </div>

  <div class="submenu-box hidden" id="submenuContainer">
    <p>Select detail:</p>
    <div id="subMenus"></div>
  </div>

  <div class="selected-info hidden">
    <p id="selectedText"></p>
  </div>

  <div class="navigation hidden">
    <button onclick="nextQuestion()">Next Question</button>
  </div>

  <div class="summary-box hidden" id="summaryBox">
    <h2>Summary</h2>
    <p id="summaryUser"></p>
    <ul id="summaryList"></ul>
    <button onclick="showLoginBox()">Restart</button>
  </div>

  <script>
    const validUserIds = ["user01", "user02", "user03", "admin", "lan"];
    let currentUserId = "";
    let questionOrder = [];
    let answeredQuestions = [];
    let currentQuestionIndex = 0;
    let switchCount = 0;
    let selectedTop = null;
    let selectionChanges = {}; 
    let firstSelection = {}; 
    let answerRecord = {}; 

    const questions = [
      "Question 1?", "Question 2?", "Question 3?", "Question 4?", "Question 5?"
    ];

    const topMenus = {
      1: { label: "Booking and Returning", subs: ["1.1", "1.2", "1.3", "1.4", "1.5"] },
      2: { label: "Study", subs: ["2.1", "2.2", "2.3", "2.4", "2.5"] },
      3: { label: "Account Management", subs: ["3.1", "3.2", "3.3", "3.4", "3.5"] },
      4: { label: "Facilities", subs: ["4.1", "4.2", "4.3", "4.4", "4.5"] },
      5: { label: "Feedback", subs: ["5.1", "5.2", "5.3", "5.4", "5.5"] }
    };

    function saveSession() {
      localStorage.setItem("quizUser", currentUserId);
      localStorage.setItem("quizAnswered", JSON.stringify(answeredQuestions));
      localStorage.setItem("quizOrder", JSON.stringify(questionOrder));
    }

    function loadSession() {
      const user = localStorage.getItem("quizUser");
      if (user) {
        document.getElementById("startBtn").classList.add("hidden");
        document.getElementById("resumeBtn").classList.remove("hidden");
        document.getElementById("newUserBtn").classList.remove("hidden");
        document.getElementById("userId").value = user;
      }
    }

    function resumeSession() {
      currentUserId = localStorage.getItem("quizUser");
      answeredQuestions = JSON.parse(localStorage.getItem("quizAnswered")) || [];
      questionOrder = JSON.parse(localStorage.getItem("quizOrder")) || [...questions];
      questionOrder = questionOrder.filter(q => !answeredQuestions.includes(q));
      currentQuestionIndex = 0;
      if (questionOrder.length === 0) {
        alert("You have completed all questions.");
        showLoginBox();
        return;
      }
      document.getElementById("loginBox").style.display = "none";
      document.querySelectorAll(".question-box, .menu-box, .navigation, .selected-info, .submenu-box").forEach(el => el.classList.remove("hidden"));
      loadQuestion();
      renderTopMenus();
    }

    function startNewSession() {
      localStorage.clear();
      document.getElementById("startBtn").classList.remove("hidden");
      document.getElementById("resumeBtn").classList.add("hidden");
      document.getElementById("newUserBtn").classList.add("hidden");
      document.getElementById("loginMessage").textContent = "";
    }

    function validateUserId(force = false) {
      const inputId = document.getElementById("userId").value.trim();
      if (validUserIds.includes(inputId)) {
        currentUserId = inputId;
        questionOrder = [...questions].sort(() => 0.5 - Math.random());
        answeredQuestions = [];
        currentQuestionIndex = 0;
        saveSession();
        document.getElementById("loginBox").style.display = "none";
        document.querySelectorAll(".question-box, .menu-box, .navigation, .selected-info, .submenu-box").forEach(el => el.classList.remove("hidden"));
        loadQuestion();
        renderTopMenus();
      } else {
        document.getElementById("loginMessage").textContent = "User ID not found.";
      }
    }

    function sendToSheet(question, topMenu, subMenu) {
      const formData = new FormData();
      formData.append("userId", currentUserId);
      formData.append("question", question);
      formData.append("topMenu", topMenu);
      formData.append("subMenu", subMenu);

      fetch("https://script.google.com/macros/s/AKfycbzeZl8HiFGm5VLw71_y96sNuPI9ZGfh3S3wqhEnq3jfeiUe3gXUbbYHLoKOj1nVKc4/exec", {
        method: "POST",
        body: formData
      })
      .then(res => res.text())
      .then(txt => console.log("Submitted:", txt))
      .catch(err => console.error("Submission error:", err));
    }

    function loadQuestion() {
      if (questionOrder.length === 0) {
        alert("All questions completed.");
        showLoginBox();
        return;
      }
      document.getElementById("question").textContent = questionOrder[currentQuestionIndex];
      document.getElementById("submenuContainer").classList.add("hidden");
      document.getElementById("selectedText").textContent = "";
      selectedTop = null;
    }

    function renderTopMenus() {
      const container = document.getElementById("topMenus");
      container.innerHTML = '';
      Object.keys(topMenus).forEach(key => {
        const btn = document.createElement("button");
        btn.textContent = `${key}. ${topMenus[key].label}`;
        btn.onclick = () => {
          selectedTop = key;
          renderSubMenus(key);
          document.getElementById("submenuContainer").classList.remove("hidden");
        };
        container.appendChild(btn);
      });
    }

    function renderSubMenus(topKey) {
      const container = document.getElementById("subMenus");
      container.innerHTML = '';
      const question = questionOrder[currentQuestionIndex];

      if (!selectionChanges[question]) selectionChanges[question] = 0;
      if (!firstSelection[question]) firstSelection[question] = false;

      topMenus[topKey].subs.forEach(sub => {
        const btn = document.createElement("button");
        btn.textContent = sub;
        btn.onclick = () => {
          if (firstSelection[question]) {
            if (selectionChanges[question] >= 2) {
              alert("You can only change your selection 2 times for each question!");
              return;
            }
            selectionChanges[question]++;
          } else {
            firstSelection[question] = true;
          }

          document.getElementById("selectedText").textContent = "You selected: " + sub;
          const topLabel = topMenus[topKey].label;
          sendToSheet(question, topLabel, sub);
          answerRecord[question] = { top: topLabel, sub };
          saveSession();
        };
        container.appendChild(btn);
      });
    }

    function nextQuestion() {
      const question = questionOrder[currentQuestionIndex];
      if (!answerRecord[question]) {
        const topLabel = selectedTop ? topMenus[selectedTop].label : "";
        sendToSheet(question, topLabel, "");
        answerRecord[question] = { top: topLabel, sub: "" };
      }
      answeredQuestions.push(question);

      if (currentQuestionIndex < questionOrder.length - 1) {
        currentQuestionIndex++;
        saveSession();
        loadQuestion();
      } else {
        showSummary();
      }
    }

    function showSummary() {
      document.querySelectorAll(".question-box, .menu-box, .submenu-box, .navigation, .selected-info").forEach(el => el.classList.add("hidden"));
      const summaryBox = document.getElementById("summaryBox");
      const summaryList = document.getElementById("summaryList");
      document.getElementById("summaryUser").textContent = `User ID: ${currentUserId}`;
      summaryList.innerHTML = '';
      questions.forEach(q => {
        const res = answerRecord[q];
        let text;
        if (!res) {
          text = `${q} → No answer`;
        } else if (res.top && res.sub) {
          text = `${q} → ${res.top} / ${res.sub}`;
        } else if (res.top) {
          text = `${q} → ${res.top}`;
        } else {
          text = `${q} → No answer`;
        }
        const li = document.createElement("li");
        li.textContent = text;
        summaryList.appendChild(li);
      });

      // Pie chart: answer breakdown
      const fullAnswers = questions.filter(q => answerRecord[q] && answerRecord[q].top && answerRecord[q].sub).length;
      const topOnlyAnswers = questions.filter(q => answerRecord[q] && answerRecord[q].top && !answerRecord[q].sub).length;
      const noAnswers = questions.length - fullAnswers - topOnlyAnswers;
      const chartContainer = document.createElement("div");
      chartContainer.innerHTML = `<canvas id='summaryChart' width='300' height='300'></canvas>`;
      summaryBox.appendChild(chartContainer);

      const chartData = [];
      const chartLabels = [];
      const chartColors = [];

      if (fullAnswers > 0) {
        chartLabels.push('Full Answer');
        chartData.push(fullAnswers);
        chartColors.push('#4caf50');
      }
      if (topOnlyAnswers > 0) {
        chartLabels.push('Top Menu Only');
        chartData.push(topOnlyAnswers);
        chartColors.push('#ff9800');
      }
      if (noAnswers > 0) {
        chartLabels.push('No Answer');
        chartData.push(noAnswers);
        chartColors.push('#f44336');
      }

      if (chartData.length > 0) {
        new Chart(document.getElementById('summaryChart'), {
          type: 'pie',
          data: {
            labels: chartLabels,
            datasets: [{
              data: chartData,
              backgroundColor: chartColors
            }]
          },
          options: {
            responsive: false,
            plugins: {
              legend: {
                position: 'bottom'
              }
            }
          }
        });
      }

      // Average idle time between questions (in seconds)
      const times = Object.values(answerRecord).map(r => r.time).filter(Boolean);
      let avgIdleTime = 0;
      if (times.length > 1) {
        const diffs = times.slice(1).map((t, i) => (t - times[i]) / 1000);
        avgIdleTime = diffs.reduce((a, b) => a + b, 0) / diffs.length;
      }
      const timePara = document.createElement("p");
      timePara.textContent = `Average idle time between questions: ${avgIdleTime.toFixed(2)} seconds`;
      summaryBox.appendChild(timePara);

      summaryBox.classList.remove("hidden");
      localStorage.clear();
    }


    function showLoginBox() {
      document.querySelectorAll(".question-box, .menu-box, .submenu-box, .navigation, .selected-info, .summary-box").forEach(el => el.classList.add("hidden"));
      document.getElementById("loginBox").style.display = "block";
      document.getElementById("resumeBtn").classList.add("hidden");
      document.getElementById("newUserBtn").classList.add("hidden");
      document.getElementById("startBtn").classList.remove("hidden");
      document.getElementById("userId").value = "";
    }

    window.onload = loadSession;
  </script>
</body>
</html>
